(()=>{"use strict";const t={translate:{es:"Traducir",eu:"Itzuli",en:"Translate",fr:"Traduire",ca:"Traduir",ga:"Traducir"},listen:{es:"Escuchar",eu:"Entzun",en:"Listen",fr:"Écouter",ca:"Escoltar",ga:"Escoitar"},loading:{es:"Cargando",eu:"Kargatzen",en:"Loading",fr:"Chargement",ca:"Carregant",ga:"Cargando"},stop:{es:"Parar",eu:"Gelditu",en:"Stop",fr:"Arrêter",ca:"Aturar",ga:"Parar"},not_allowed:{es:"No disponible",eu:"Ez erabilgarri",en:"Not available",fr:"Non disponible",ca:"No disponible",ga:"Non dispoñible"}},e={es:"Seleccionado",en:"Selected",fr:"Sélectionné",eu:"Aukeratua",gl:"Seleccionado",ca:"Seleccionat"},a={es:"La función de escucha no está disponible para el idioma seleccionado",en:"The listening feature is not available for the selected language",fr:"La fonction d'écoute n'est pas disponible pour la langue sélectionnée",eu:"Entzute funtzioa ez dago erabilgarri hautatutako hizkuntzarako",gl:"A función de escoita non está dispoñíbel para a lingua escollida",ca:"La funció d'escolta no està disponible per a l'idioma seleccionat"},s={es:["Juan"],eu:["Nerea","Mikel"]},o={getHostname:()=>{let t=location.host;return t=2===t.split(".").length?`www.${t}`:t,location.protocol+"//"+t},getURL:()=>o.getHostname()+location.pathname,getSiteLang:async(t,e)=>{try{const a=await fetch(`${e}/langdetect`,{method:"POST",body:JSON.stringify({url:o.getURL(),selectors:t.translationSelectors})}),s=await a.json();if(!a.ok||s?.error)throw new Error("Request to API failed.");const n=s?.data?.language;if(!n)throw new Error("No language received.");return n}catch(t){return console.warn("[TREBE] Ha habido un error al obtener el idioma origen via nuestra API."),null}},populateTextSelectors:t=>["p","li","h1","h2","h3","h4","h5","h6"].map((e=>`${t} ${e}`)),displayErrorMessage:t=>{alert(t)}},n=o;class i{constructor(t){this.API_URL=t.API_URL,this.sourceLanguage=t.sourceLanguage,this.url=t.url,this.targetLanguage=null,this.selectors=t.translationSelectors,this.ui=t.ui,this.labelDefaultLang=t.labelDefaultLang,this.states={NOT_LOADING:0,LOADING:1},this._attachEventListeners(),this._setSelectedLanguage(this.sourceLanguage),console.log("[TREBE] Translator initialized correctly")}async _translatePageContent(){try{const t=await fetch(`${this.API_URL}/translate`,{method:"POST",body:JSON.stringify({url:this.url,targetlanguage:this.targetLanguage,selectors:this.selectors})}),e=await t.json();if(!t.ok||e?.error)throw new Error("Request to API failed.");if(0===e.data.length)throw new Error("No data received.");return e.data}catch(t){throw n.displayErrorMessage("Ha habido un error al llamar al servicio."),t}}_updateTranslatedTexts(t){t.forEach((t=>{const{selector:e,translatedHTML:a}=t,s=document.querySelector(e);s&&(s.outerHTML=a)}))}_updateUIState(e){switch(e){case this.states.LOADING:this.ui.translateLabel.textContent=t.loading[this.sourceLanguage||this.labelDefaultLang],this.ui.translateButton.disabled=!0,this.ui.translateDropBtn.disabled=!0,this.ui.translateButton.classList.add("wait"),this.ui.translateIcon.classList.value="fas fa-spinner fa-pulse",this.ui.ttsDropBtn.disabled=!0,this.ui.ttsButton.disabled=!0;break;case this.states.NOT_LOADING:this.ui.translateLabel.textContent=t.translate[this.sourceLanguage||this.labelDefaultLang],this.ui.translateButton.disabled=!1,this.ui.translateDropBtn.disabled=!1,this.ui.translateButton.classList.remove("wait"),this.ui.translateIcon.classList.value="fas fa-language",this.ui.ttsButton.disabled=!1}}_getLanguageCodes(){return Array.from(this.ui.translateDropdown?.children).map((t=>t.id))}_setSelectedLanguage(t){if(!t)return;const a=this.ui.translateDropdown.querySelector(`#${t}`);a.setAttribute("disabled","disabled"),a.classList.add("selectedLanguage"),a.title=e[this.sourceLanguage||this.labelDefaultLang]}_removeSelectedLanguage(t){if(!t)return;const e=this.ui.translateDropdown.querySelector(`#${t}`);e.removeAttribute("disabled"),e.classList.remove("selectedLanguage"),e.removeAttribute("title")}_toggleDropdown(){this.ui.translateDropdown.classList.toggle("trebeShown")}_attachEventListeners(){this.ui.translateDropdown.querySelectorAll("li").forEach((t=>{t.addEventListener("click",(t=>{this._handleLanguageSelection(t)}))})),this.ui.translateDropBtn.addEventListener("click",(()=>{this._toggleDropdown()}))}_handleLanguageSelection(t){const e=t.target;if(e.attributes.disabled)return void console.log("[TREBE] Selected language is disabled. Won't translate.");const a=this._getLanguageCodes(),s=e.id;a.includes(s)&&(this.targetLanguage=s,this._translatePage())}async _translatePage(){if(console.log(`[TREBE] Translating from to ${this.targetLanguage}...`),this.targetLanguage){this._updateUIState(this.states.LOADING);try{if(0===this.selectors.length)return void console.log("[TREBE] No selector specified (variable 'this.translationSelectors' is empty)");const t=await this._translatePageContent();this._updateTranslatedTexts(t);const e=t.map((t=>t.selector));this._postTranslation(e),console.log("[TREBE] Translation finished."),this._getLanguageCodes().forEach((t=>{this._removeSelectedLanguage(t)})),this._setSelectedLanguage(this.targetLanguage)}catch(t){console.error(t)}finally{this._updateUIState(this.states.NOT_LOADING)}}else console.log("[TREBE] No target language specified. Won't translate.")}_postTranslation(t){t.forEach((t=>{document.querySelectorAll(`${t} .lozad`).forEach((t=>{const e=t.getAttribute("data-src")||t.getAttribute("data-iesrc");if(e)if("PICTURE"===t.tagName){const a=document.createElement("img");a.src=e,a.alt=t?.dataset.alt,t.appendChild(a)}else t.src=e}))}));try{document.querySelectorAll(".fb-post").length>0&&FB.XFBML.parse()}catch(t){console.error("There has been an error refreshing the twitter widgets: ",t)}try{document.querySelectorAll(".twitter-tweet").length>0&&twttr.widgets.load()}catch(t){console.error("There has been an error refreshing the twitter widgets: ",t)}try{document.querySelectorAll(".instagram-media").length>0&&instgrm.Embeds.process()}catch(t){console.error("There has been an error refreshing the instagram widgets: ",t)}}}class r{constructor(t){this.WS_URL=t.API_URL+"/tts",this.socket=null,this.sourceLanguage=t.sourceLanguage,this.ui=t.ui,this.selectors=t.selectors,this.excludedSelectors=t.excludedSelectors,this.availableLanguages=["es","eu"],this.labelDefaultLang=t.labelDefaultLang,this.audioQueue=[],this.textQueue=[],this.isPlaying=!1,this.audioEl=null,this.states={STOPPED:0,LOADING:1,PLAYING:2,BLOCKED:3},this._attachEventListeners(),this.populateModelNames(this.sourceLanguage||this.labelDefaultLang)}_attachEventListeners(){this.ui.ttsButton?.addEventListener("click",(()=>{this._handleTTS()})),this.ui.ttsDropBtn?.addEventListener("click",(()=>{this._toggleDropdown()})),new MutationObserver((t=>{t.forEach((t=>{const{target:e}=t;if("LI"===e.tagName&&"class"===t.attributeName&&e.classList.contains("selectedLanguage")){const t=e.id;this.availableLanguages.includes(t)?(this._updateUIState(this.states.STOPPED),this.populateModelNames(t)):this._updateUIState(this.states.BLOCKED)}}))})).observe(this.ui.translateDropdown,{attributes:!0,childList:!0,subtree:!0})}populateModelNames(t){if(!t)return;this.ui.ttsDropdown.innerHTML="";const e=s[t];if(!e)return;e.map((t=>{const e=document.createElement("li");e.id=t,e.textContent=t,this.ui.ttsDropdown.appendChild(e)}));const a=this.ui.ttsDropdown.querySelector("li");this._selectModelName(a),this.ui.ttsDropdown?.querySelectorAll("li").forEach((t=>{t.addEventListener("click",(t=>{this._handleModelNameSelection(t)}))}))}_selectModelName(t){t&&(t.classList.add("selectedModelName"),t.setAttribute("disabled","disabled"),t.title=e[this.sourceLanguage||this.labelDefaultLang])}_handleModelNameSelection(t){this.ui.ttsDropdown.querySelectorAll("li").forEach((t=>{t.classList.remove("selectedModelName"),t.removeAttribute("disabled"),t.removeAttribute("title")}));const e=t.target;this._selectModelName(e)}_toggleDropdown(){this.ui.ttsDropdown.classList.toggle("trebeShown")}_handleTTS(){this.isPlaying?this._stopTTS():this._startTTS()}_getLanguageCode(){return this.ui.translateDropdown.querySelector(".selectedLanguage")?.id||this.labelDefaultLang}_updateUIState(e){switch(this.ui.ttsButton.removeAttribute("title"),e){case this.states.LOADING:this.ui.ttsDropBtn.disabled=!0,this.ui.ttsButton.disabled=!0,this.ui.ttsLabel.textContent=`${t.loading[this.sourceLanguage||this.labelDefaultLang]}...`,this.ui.ttsIcon.classList.value="fas fa-spinner fa-pulse",this.ui.translateButton.disabled=!0,this.ui.translateDropBtn.disabled=!0;break;case this.states.STOPPED:this.ui.ttsDropBtn.disabled=!1,this.ui.ttsButton.disabled=!1,this.ui.ttsLabel.textContent=`${t.listen[this.sourceLanguage||this.labelDefaultLang]}`,this.ui.ttsIcon.classList.value="fas fa-play",this.ui.translateButton.disabled=!1,this.ui.translateDropBtn.disabled=!1;break;case this.states.PLAYING:this.ui.ttsDropBtn.disabled=!0,this.ui.ttsButton.disabled=!1,this.ui.ttsLabel.textContent=t.stop[this.sourceLanguage||this.labelDefaultLang],this.ui.ttsIcon.classList.value="fa-solid fa-pause";break;case this.states.BLOCKED:this.ui.ttsButton.title=a[this.sourceLanguage||this.labelDefaultLang],this.ui.ttsDropBtn.disabled=!0,this.ui.ttsButton.disabled=!0,this.ui.ttsLabel.textContent=`${t.not_allowed[this.sourceLanguage||this.labelDefaultLang]}`,this.ui.ttsIcon.classList.value="fa-solid fa-ban",this.ui.translateButton.disabled=!1,this.ui.translateDropBtn.disabled=!1}}_stopTTS(){this.socket.close(),this.audioEl&&this.audioEl.pause(),this.isPlaying=!1,this.audioQueue.length=0,this.textQueue.length=0,this._clearHighlights(),this._updateUIState(this.states.STOPPED)}_queueAudio(t){this.audioQueue.push(t),this.isPlaying||this._playNext()}_highlightCurrent(){console.log("[TREBE] highlightNext()");const t=this.textQueue.shift().trim(),e=this._findElementByTextContent(t);if(e)return this._highlightSentence(e,t),e}_setIsPlaying(){this.isPlaying=!0,this._updateUIState(this.states.PLAYING)}_highlightSentence(t,e){const a=t.textContent.indexOf(e);if(-1===a)return;const s=a+e.length,o=[];let n=0;const i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT);let r;for(;r=i.nextNode();){const t=r.textContent.length;o.push({node:r,start:n,end:n+t}),n+=t}o.filter((t=>t.start<s&&t.end>a)).forEach((t=>{const e=Math.max(a-t.start,0),o=Math.min(s-t.start,t.end-t.start);if(e>=o)return;const n=document.createRange();n.setStart(t.node,e),n.setEnd(t.node,o);const i=document.createElement("span");i.classList.add("tts-highlight");try{n.surroundContents(i)}catch(t){this.audioQueue.length=0,this.textQueue.length=0,console.error("Error highlighting:",t)}}))}_findElementByTextContent(t){for(const e of this.selectors){const a=document.querySelectorAll(e);for(const e of a)if(e.textContent.includes(t))return console.log("[TREBE] Element found: ",e),e}console.log("[TREBE] No element found for text: ",t)}_clearHighlights(){document.querySelectorAll("span.tts-highlight").forEach((t=>{t.replaceWith(...t.childNodes)}))}_playNext(){if(this._clearHighlights(),0===this.audioQueue.length)return void this._stopTTS();this._highlightCurrent(),this._setIsPlaying(!0);const t=this.audioQueue.shift(),e=new Blob([t],{type:"audio/wav"}),a=URL.createObjectURL(e);this.audioEl=new Audio(a),this.audioEl.onended=()=>{URL.revokeObjectURL(a),this._playNext()},this.audioEl.onerror=t=>{console.error("Audio playback error:",t,this.audioEl.error),URL.revokeObjectURL(a),this._playNext()},this.audioEl.play().catch((t=>{console.error("Playback promise error:",t)}))}async _startTTS(){this.selectors?this.availableLanguages.includes(this._getLanguageCode())?(this._updateUIState(this.states.LOADING),this.socket=new WebSocket(this.WS_URL),this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{const t={url:n.getURL(),languageCode:this._getLanguageCode(),selectors:this.selectors,excludedSelectors:this.excludedSelectors,modelname:this.ui.ttsDropdown.querySelector(".selectedModelName")?.id||void 0};console.log("requestData: ",t),this.socket.send(JSON.stringify(t))},this.socket.onmessage=t=>{if("string"==typeof t.data)try{JSON.parse(t.data).error&&(n.displayErrorMessage("Ha habido un error interno."),this._stopTTS())}catch(t){console.error("Error parsing text message:",t)}else this._processWebSocketMessage(t.data)},this.socket.onerror=t=>{console.error("WebSocket error:",t),n.displayErrorMessage("Ha habido un error en el socket."),this._stopTTS()},this.socket.onclose=t=>{console.log("WebSocket closed",t),this._stopTTS()}):n.displayErrorMessage("El idioma actual no está implementado para la función de escuchar."):n.displayErrorMessage("Hay un error de configuración de la herramienta")}_processWebSocketMessage(t){const e=t;if(e.byteLength<4)return void console.error("Received message too short: ",e.byteLength);const a=new DataView(e).getUint32(0,!1);if(e.byteLength<4+a)return void console.error("The message doesn't contain full header.");const s=new Uint8Array(e,4,a),o=new TextDecoder("utf-8").decode(s);let n;try{n=JSON.parse(o)}catch(t){return void console.error("Error parsing JSON header: ",t)}const i=new Uint8Array(e,4+a);this.textQueue.includes(n.sentence)||this.textQueue.push(n.sentence),this._queueAudio(i)}}class l extends Error{constructor(...t){super(...t),Error.captureStackTrace&&Error.captureStackTrace(this,l),this.name="ValidationError"}}class c{constructor(t){this.API_URL=t.API_URL,this.sourceLanguage=t.sourceLanguage,this.siteConfig=t.siteConfig,this.url=n.getURL(),this.ui={},this.labelDefaultLang=document.querySelector("html").lang,this.translator,this.tts,this._injectFontAwesome(),this._injectCSS(),this._injectHTML(),this._attachEventListeners(),console.log("[TREBE] Toolbar initialized correctly."),console.log("[TREBE] Site config: ",this.siteConfig),this._loadUI(),this._instanceTranslator(),this._instanceTTS(),this._onLoad()}static async create(t){if(!t.siteConfig)throw new l("[TREBE] Tool not implemented for this site. Hostname: "+n.getHostname());if(t.siteConfig.validationCallback&&!t.siteConfig.validationCallback())throw new l("[TREBE] Not implementing tool in this page. Callback didn't pass: Callback: "+t.siteConfig.validationCallback);const e=await n.getSiteLang(t.siteConfig,t.API_URL);return console.log("[TREBE] Detected site language:",e),console.log("[TREBE] Creating TrebeToolbar instance..."),new c({...t,sourceLanguage:e})}_onLoad(){this.siteConfig.onLoad&&(console.log("[TREBE] Executing onload function..."),this.siteConfig.onLoad())}_loadUI(){this.ui={translateDropdown:document.getElementById("trebe-translate-dropdown"),translateDropBtn:document.getElementById("trebe-translate-dropbtn"),translateButton:document.getElementById("trebeTranslateButton"),translateLabel:document.getElementById("trebeTranslateLabel"),translateIcon:document.getElementById("trebeTranslateIcon"),ttsDropdown:document.getElementById("trebe-tts-dropdown"),ttsDropBtn:document.getElementById("trebe-tts-dropbtn"),ttsButton:document.getElementById("trebeTtsButton"),ttsLabel:document.getElementById("trebeTtsLabel"),ttsIcon:document.getElementById("trebeTtsIcon")};for(const t in this.ui)this.ui[t]||console.error(`[TREBE] UI Element "${t}" not found after injection. Toolbar might malfunction.`)}_injectHTML(){const e=this.API_URL.includes("localhost")?"background: #fff8e4":"",a=`\n        <div class="trebeToolbar ${e?"localhostWarn":""}" style="${e}">\n            <div class="trebeToolbarDiv">\n                <div class="trebeDropdown">\n                    <button id="trebeTranslateButton">\n                      <span id="trebeTranslateLabel" class="btn-text">${t.translate[this.sourceLanguage||this.labelDefaultLang]}</span>\n                      <i id="trebeTranslateIcon" class="btn-icon fas fa-language"></i>\n                    </button>\n                    <button id="trebe-translate-dropbtn" class="trebe-dropbtn">\n                        <i class="fas fa-chevron-down"></i>\n                    </button>\n                    <div id="trebe-translate-dropdown" class="trebe-dropdown">\n                        <li id="es">Español</li>\n                        <li id="eu">Euskara</li>\n                        <li id="en">English</li>\n                        <li id="fr">Français</li>\n                        <li id="ca">Català</li>\n                        <li id="gl">Galego</li>\n                    </div>\n                </div>\n            </div>\n            <div class="trebeToolbarDiv">\n              <div class="trebeDropdown">\n                <button id="trebeTtsButton">\n                  <span id="trebeTtsLabel" class="btn-text">${t.listen[this.sourceLanguage||this.labelDefaultLang]}</span>\n                  <i id="trebeTtsIcon" class="fas fa-play"></i>\n                </button>\n                <button id="trebe-tts-dropbtn" class="trebe-dropbtn">\n                    <i class="fas fa-chevron-down"></i>\n                </button>\n                <div id="trebe-tts-dropdown" class="trebe-dropdown">\n                </div>\n              </div>\n            </div>\n        </div>\n      `;document.querySelector(this.siteConfig.targetInject).insertAdjacentHTML(this.siteConfig.injectPosition,a)}_injectCSS(){const t=document.createElement("style");t.innerHTML='\n        :root {--trebe-primary-color:#343a40;--trebe-secondary-color:#b6c2cd;--trebe-background-color:#ffffff;--trebe-border-color:#cdd0d3;--trebe-hover-bg:#e9ecef;--trebe-dropdown-shadow:0 8px 16px rgba(0, 0, 0, 0.2);--trebe-btn-padding:0.5rem}\n        .trebeToolbar {display:flex; gap: 10px; margin: 10px 0px;}\n        .localhostWarn::before {content: "POINTING TO LOCALHOST"; font-size: 0.8rem; display: flex; align-items: center; font-style: italic;}\n        .trebeToolbarDiv {box-sizing:border-box;border:1px solid var(--trebe-border-color);border-radius:6px;padding:var(--trebe-btn-padding)}\n        .trebeToolbarDiv,.trebeToolbarDiv>div {display:inline-flex;align-items:center;position:relative}\n        .trebeToolbarDiv :disabled,.trebeToolbarDiv [disabled] {cursor:not-allowed!important;color:var(--trebe-secondary-color)!important}\n        .trebeToolbarDiv .wait {cursor:wait!important}\n        #trebeTtsButton,.trebe-dropbtn {cursor:pointer}\n        .tts-highlight {background-color:#ff0!important}\n        .trebe-dropdown {text-align:center;display:none;position:absolute;top:115%;left:0;min-width:100px;background-color:var(--trebe-background-color);border:1px solid var(--trebe-border-color);border-radius:4px;box-shadow:var(--trebe-dropdown-shadow);z-index:1000;padding:0 8px;margin:0;list-style:none}\n        .trebe-dropbtn {border-left:1px solid var(--trebe-hover-bg)!important;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;color:var(--trebe-primary-color);position:relative}\n        .trebe-dropdown li {user-select:none;color:var(--trebe-primary-color)!important;padding:.5rem .75rem;margin:0;text-decoration:none;display:block;border-bottom:1px solid var(--trebe-border-color);cursor:pointer}\n        .trebe-dropdown li:last-child {border-bottom:none}\n        .trebe-dropdown li:not([disabled]):hover {background-color:var(--trebe-hover-bg)}\n        .trebeShown {display:block}\n        .trebeToolbarDiv button {border:none;padding:0 .5rem;background-color:#fff0;box-shadow:none;font:inherit;color:inherit}\n        .trebeToolbarDiv i {pointer-events:none}\n        #trebeTranslateButton {cursor:default;color:var(--trebe-primary-color)}\n        #trebe-tts-dropdown li[title], #trebe-translate-dropdown li[title] {cursor:help!important}\n        .btn-text {display:inline}\n        .fa-language {display:none!important}\n        @media (max-width:600px) {\n          .btn-text{display:none}\n          .fa-language{display:inline-block!important}\n        }\n      ',document.head.appendChild(t)}_attachEventListeners(){window.onclick=t=>{t.target.matches(".trebe-dropbtn")||"disabled"==t.target.getAttribute("disabled")||(this.ui.translateDropdown.classList.contains("trebeShown")&&this.ui.translateDropdown.classList.remove("trebeShown"),this.ui.ttsDropdown.classList.contains("trebeShown")&&this.ui.ttsDropdown.classList.remove("trebeShown"))}}_injectFontAwesome(){const t=document.createElement("link");t.rel="stylesheet",t.href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css",document.head.appendChild(t)}_instanceTranslator(){this.translator=new i({API_URL:this.API_URL,ui:this.ui,url:this.url,sourceLanguage:this.sourceLanguage,labelDefaultLang:this.labelDefaultLang,translationSelectors:this.siteConfig.translationSelectors})}_instanceTTS(){this.tts=new r({API_URL:this.API_URL,ui:this.ui,sourceLanguage:this.sourceLanguage,labelDefaultLang:this.labelDefaultLang,selectors:this.siteConfig.ttsSelectors,excludedSelectors:this.siteConfig.ttsExcludedSelectors})}}window.trebeToolbarInstance?console.log("[TREBE] Toolbar instance already exists. Skipping initialization."):async function(){console.log("[TREBE] Initializing Toolbar Script...");try{const t=window.trebeToolbarConfig;if(t){const e=document.getElementById("trebe-toolbar-script").dataset.apiUrl;if(!e)throw new l("[TREBE] Could not read API url value from the script tag. The toolbar won't be implemented.");const a=await c.create({API_URL:e,siteConfig:t});a?(window.trebeToolbarInstance=a,console.log("[TREBE] Toolbar instance created successfully:",window.trebeToolbarInstance)):console.log("[TREBE] Toolbar creation skipped due to validation failure or lack of config.")}else console.log(`[TREBE] No site configuration found for ${hostname}. Toolbar not loaded.`)}catch(t){t instanceof l?console.warn(t):console.error("[TREBE] Fatal error during toolbar initialization:",t)}}()})();